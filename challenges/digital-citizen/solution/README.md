This challenge implements a hardware flaw in a smartcard as detailed in the paper [Factoring RSA keys from certified smart cards:
Coppersmith in the wild](https://www.iacr.org/archive/asiacrypt2013/82700341/82700341.pdf). One of the paper authors, Tanja Lange has a [video about the bit-pattern flaw](https://www.youtube.com/watch?v=00kBm4POXDw) and [another with some details about the Coppersmith attack](https://www.youtube.com/watch?v=42lKSiyHnDY).

Several hints have been dropped in the challeng, including the names of the smartcard chip and several of the author's of the paper.

Players need to first figure out that when the "true" RNG is selected primes are often generated with a bit pattern. There are two ways they can easily do this. The first is to generate a key pair for themself and then using the private exponent provided they can factor n to find p and q. This is not the *intended* way but I've left it in just in case players don't think of the intended way.

The intended way is with "batch" GCD.

Players can collect a bunch of generated key modulii to spot the bit patterns. Using these commands in a loop:

    genkey
    first
    last
    true
    exit

Then all pairs can be GCD'd to find that they often share prime factors. The included `gcd_mods.py` is an example of how to do this using the slow `O(N^2)` approach.

Once a bunch of primes have been found, they must be studied to understand the bit patterns. A big shortcut is simply to find the paper which describes the details well.

The included `generate_all_pattern_primes.py` will produce all possible primes that don't have the extra errors in them. Thes primes can then be used via trial division to factor Citizen 0's key:


    digital-citizen> listkeys
    
    Citizen  0. (DJB Tanja Lange)
    Public n: 0xe1b3626649dc38ed5921650f6ccb6acc8ff9aaec9dd256ca7a7a1a0b3d9f615266ebb5e25671b3c96df44f84034c509e2995e27160f8021e7946b3f03873e5179f26a52527bdf56e0b503df03757f7998b418f666864ebfddb46251afb9c954dc24f6363c56e66b3edcbb2f5db625fbfbb11c0252f4e431a8920669821e4774f
    Public e: 0x10001
    
    Citizen  1. (Coppersmith Howgrave-Graham)
    Public n: 0xbe3890a7605bb8d1dd03cf5060b9eb02d110d34d966ee4b277b32bbbeb23563ae860273715a06c6c8a8cd5c2547fe6d0fdcac172fb40a42272aebf63a53e68eb11f905ae064af33d0a128214ba00130ec49efc6060789d3c481256fd3ee55c4e4f6634958e6271be458e1d8fbe8165f224133cb5a00ac2adc80967447fcc787f
    Public e: 0x10001
    
    digital-citizen> readmsg
    
    Enter citizen (by number) to read unread messages? 0
    
    Welcome DJB(?), before we continue, you must prove it's you
    
    Please provide the signature for 230846000006996554864145385787482093092 : 125665049994521047592213989932197112873186687546276432005443406401430333613257634269589578348237799429135156121798275374508064683723621425513192280449451697910336729131939065229340964639715230843118143335090285527168417260573489854133322270651175328592279395638757537287483277830970735543163010551090957686203
    Message 1: Dan, I think our smartcards may have errors... CTF{never_trust_a_black_box}


For part 2, players must identify that sometimes pattered primes have 48 random bits in the lower quarter. Following the paper, Coppersmith can be used

The provide Sage code `trial_coppersmith.sage` will try Coppersmith for every candidate pattern prime to find one that is close to the true prime:

    $ sage trial_coppersmith.sage ../challenge/all_prime_pats.txt be3890a7605bb8d1dd03cf5060b9eb02d110d34d966ee4b277b32bbbeb23563ae860273715a06c6c8a8cd5c2547fe6d0fdcac172fb40a42272aebf63a53e68eb11f905ae064af33d0a128214ba00130ec49efc6060789d3c481256fd3ee55c4e4f6634958e6271be458e1d8fbe8165f224133cb5a00ac2adc80967447fcc787f
    Will run coppersmith on be3890a7605bb8d1dd03cf5060b9eb02d110d34d966ee4b277b32bbbeb23563ae860273715a06c6c8a8cd5c2547fe6d0fdcac172fb40a42272aebf63a53e68eb11f905ae064af33d0a128214ba00130ec49efc6060789d3c481256fd3ee55c4e4f6634958e6271be458e1d8fbe8165f224133cb5a00ac2adc80967447fcc787f
    Factored 133577698805057016797872501581857932334036266534383638107627559872779334251897555258368822964022760603903113514481889599069121455777975259249987651055195456891753095779357927775639520603949542775231054409379550546668187959836787195371838529518956472549678173033917731782141897228452090263651277509669161826431 into 10224440781765333959355922271489914285643504021433214729193598363060104467297826270788176367257585365591779758394700098038443556892020403049342313863107283 and 13064548140694862169416720694932396335702533163770688071299418975271943150184391427980329462743656568003133841483640813591166806253464449263323015424901157
    p bits: 11111001011100100010111001011100100101110010111011100101110010110111001011100101010111001011100100101110010111001100101110010111111001011100101110111001011100100101110010111001100101110010111011001011100101110111001011100101101110010111001000101110010111001001011100101110111001011100101101110010111001010101110010111001001011100101110011001011100101111110010111001011101110010111001001011100101110011001011100101110110010111001011101110010111001011011111000110000110101010000010101010000111110100000000000100101
    q bits: 11000011001110000000011010000111011111111110101110110010111010101110111001100000100010000100110000111010000011100101011111110111010111110000111110101000101111000100001010110001011010001100110010001001111111101011000010001100100110101010111010111011011100100100101001011001101101010000110001000011101101000010011011101011001011100101110100110100100100101111010100001101100111100111001011110111001001011101100100011011011101000011101000100011101000010000001000110001010101110001011000110101001000001101001011010011


Then using this factorization:

    digital-citizen> readmsg
    
    Enter citizen (by number) to read unread messages? 1
    
    Welcome Coppersmith(?), before we continue, you must prove it's you
    
    Please provide the signature for 50270568158361420948375087748410436443 : 73163237629005064336312497586488848914405537328679620940037648182376013545742356025880857173376242622691981882220020358907385452998217039198141142167782200948108051680035638969869299687017803053006930384658283757222385290952137904610460001450381722518099218750515590971187687815369334678783770480232930580474
    Message 1: Even when the HW RNG gets going it isn't secure CTF{for_bits_location_is_everything}
    

