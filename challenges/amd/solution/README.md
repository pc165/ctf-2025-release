This challenge is based on Google's [Zen and the Art of Microcode Hacking](https://bughunters.google.com/blog/5424842357473280/zen-and-the-art-of-microcode-hacking) post.

The vulnerability is the same CMAC-of-RSA-key is not secure.

You can use aes_cmac.py to find a pre-image fo AES-CMAC with:

    def break_aes_cmac(message, K, H):
    
        aes = AES.new(K, AES.MODE_ECB)
        K1 = generate_subkey(K)
    
        n = len(message) // 16
        last_block = xor_bytes(message[-16:], K1)
    
        # Compute MAC all the way up to the last two blocks
        X = b'\x00' * 16
        for i in range(n - 2):
            block = message[i * 16:(i + 1) * 16]
            X = aes.encrypt(xor_bytes(X, block))
    
        # run last block bacwards
        XL = xor_bytes(aes.decrypt(H), last_block)
    
        # Now aes(X xor M') must be XL so compute M'
        MP = xor_bytes(aes.decrypt(XL), X)
    
        return message[:len(message) - 32] + MP + message[-16:]


There is also code in there to check if the resulting number is the product of two primes. Using a modulus found with that tool build_forged_blob.py do the "firmware" code signing.

The shellcode in print_flag.asm can be assembled (`nasm -o print_flag.bin print_flag.asm`) and fed to the blob creation for a full working solution.


    $ python3 ./build_forged_blob.py print_flag.bin | netcat 127.0.0.1 8664
    Welcome to the Advanced Machinecode Defense update utility!
    Enter hex lines of firmware blob. Type 'END' when finished:
    Got 91 bytes, padding with nulls to 1024
    Firmware SHA256: c07d370cd4559abe7f8b16469d351f4bd413c13007a6b1eb1e83aaa4db375e66
    Signing padded hash
    8000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    ffbafc003cc2ef1acd2696de5debd9fd00000000000000000000000000000275
    eb415f4831f64831d2b8020000000f054889c74881ec00010000488d3424ba00
    010000b8000000000f05bf010000004889c2b8010000000f054831ffb83c0000
    000f05e8baffffff2f686f6d652f6374662f666c61672e747874000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000000
    6fd93559b1a21db441df3ef05f4d7c2591f876d419f41deeb3f51561f37a275f
    8dcb8bf0e00b45f33b8265807787f2cd5bf43f59b0b4520a022127f196b67002
    e99d37d0fa439eb5fe7248d40a41a20a9ac593a46434125b717ad7f485777fd0
    912298e9a52fb8aa6087502e66e1dd23712358e07ecfb23ffe24ce9f9458e1f3
    1cecdca3895349fdb7ad90b6fa6001ac2d8af92bdfb62d404ebb6083837544da
    fa9fe75823063d0ad6d04ce91f779ebb62acc56ab402e45be882bc36192a2b1b
    fa56c5be694c2eaa8de299b154e6a186c4f25bc69b6314a7ba93800211fc0e75
    6f25c152cb4772c217015b59c45945a117ce8c6c570703f768a13cc4a36a4ce9
    END
    INFO: Computed RSA key CMAC: 9ccc7c881faa8225ba686d772ac60dc3
    INFO: Trusted CMAC: 9ccc7c881faa8225ba686d772ac60dc3
    INFO: RSA key is trusted.
    INFO: SHA256 of firmware: c07d370cd4559abe7f8b16469d351f4bd413c13007a6b1eb1e83aaa4db375e66
    INFO: Modulus: 8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffbafc003cc2ef1acd2696de5debd9fd00000000000000000000000000000275
    INFO: will verify signature: 6fd93559b1a21db441df3ef05f4d7c2591f876d419f41deeb3f51561f37a275f8dcb8bf0e00b45f33b8265807787f2cd5bf43f59b0b4520a022127f196b67002e99d37d0fa439eb5fe7248d40a41a20a9ac593a46434125b717ad7f485777fd0912298e9a52fb8aa6087502e66e1dd23712358e07ecfb23ffe24ce9f9458e1f31cecdca3895349fdb7ad90b6fa6001ac2d8af92bdfb62d404ebb6083837544dafa9fe75823063d0ad6d04ce91f779ebb62acc56ab402e45be882bc36192a2b1bfa56c5be694c2eaa8de299b154e6a186c4f25bc69b6314a7ba93800211fc0e756f25c152cb4772c217015b59c45945a117ce8c6c570703f768a13cc4a36a4ce9
    INFO: Firmware signature is valid.
    INFO: Allocating new writable memory for machinecode.
    INFO: Copying verified machinecode to writable memory.
    INFO: Changing memory protection to executable.
    INFO: Starting hardware watchdog with 5 second timeout.
    INFO: Calling newly loaded machinecode function.
    CTF{zen_and_the_art_of_bad_crypto}

